Index: app/models/User.ts
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import mongoose, { Schema } from \"mongoose\";\r\n\r\nconst UserSchema = new Schema({\r\n    email: {\r\n        type: String,\r\n        required: [true, \"Пожалуйста, введите email\"],\r\n        unique: true,\r\n        lowercase: true,\r\n        trim: true,\r\n    },\r\n\r\n    password: {\r\n        type: String,\r\n        required: [true, \"Пожалуйста, введите пароль\"],\r\n        select: false,\r\n    },\r\n    name: {\r\n        type: String,\r\n        required: [true, \"Пожалуйста, введите имя\"],\r\n        trim: true,\r\n    },\r\n\r\n}, { timestamps: true });\r\n\r\nconst User = mongoose.models.User || mongoose.model('User', UserSchema);\r\n\r\nexport default User;
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/models/User.ts b/app/models/User.ts
--- a/app/models/User.ts	(revision 73ce9bec024038fa1fdaf282b016616e948edbf0)
+++ b/app/models/User.ts	(date 1765765760093)
@@ -1,27 +1,44 @@
-import mongoose, { Schema } from "mongoose";
+import mongoose, { Schema, Document, Model } from "mongoose";
 
-const UserSchema = new Schema({
+export interface IUser extends Document {
+    name: string;
+    email: string;
+    password: string;
+    image?: string;
+    createdAt: Date;
+    updatedAt: Date;
+}
+
+const UserSchema = new Schema<IUser>({
+    name: {
+        type: String,
+        required: [true, "Пожалуйста, введите имя"],
+        trim: true,
+        maxlength: [100, "Имя не может превышать 100 символов"],
+    },
     email: {
         type: String,
-        required: [true, "Пожалуйста, введите email"],
+        required: [true, "Пожалуйста, введите адрес электронной почты"],
         unique: true,
+        trim: true,
         lowercase: true,
-        trim: true,
+        match: [/.+\@.+\..+/, "Пожалуйста, введите действительный адрес электронной почты"],
     },
-
     password: {
         type: String,
         required: [true, "Пожалуйста, введите пароль"],
+        minlength: [6, "Пароль должен содержать не менее 6 символов"],
         select: false,
     },
-    name: {
+    image: {
         type: String,
-        required: [true, "Пожалуйста, введите имя"],
-        trim: true,
-    },
+        default: '/images/avatar-default.png'
+    }
+}, {
+    timestamps: true
+});
 
-}, { timestamps: true });
 
-const User = mongoose.models.User || mongoose.model('User', UserSchema);
+const User: Model<IUser> = mongoose.models.User || mongoose.model<IUser>('User', UserSchema);
 
 export default User;
\ No newline at end of file
Index: app/profile/page.tsx
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>\"use client\";\r\n\r\nimport { useSession, signOut } from \"next-auth/react\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\nexport default function ProfilePage() {\r\n    const { data: session, status } = useSession();\r\n    const router = useRouter();\r\n\r\n    if (status === \"loading\") {\r\n        return <div className=\"p-8 text-center\">Загрузка...</div>;\r\n    }\r\n\r\n    if (status === \"unauthenticated\") {\r\n        router.replace('/auth/login');\r\n        return null;\r\n    }\r\n\r\n    const user = session!.user!;\r\n\r\n    return (\r\n        <div className=\"px-[max(12px,calc((100%-1208px)/2))] py-20 min-h-[60vh]\">\r\n            <h1 className=\"text-3xl font-bold mb-8 border-b pb-4\">Личный Кабинет</h1>\r\n\r\n            <div className=\"flex flex-col md:flex-row gap-12\">\r\n                <div className=\"w-full md:w-1/4 flex flex-col items-center\">\r\n                    <img\r\n                        src=\"/images/avatar.jpg\"\r\n                        alt={user.name || \"Аватар\"}\r\n                        width={120} height={120}\r\n                        className=\"rounded-full shadow-lg mb-4\"\r\n                    />\r\n                    <p className=\"text-xl font-semibold mb-2\">{user.name}</p>\r\n\r\n                    <button\r\n                        onClick={() => signOut({ callbackUrl: '/auth/login' })} // Перенаправляем на логин после выхода\r\n                        className=\"mt-4 bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600 transition-colors w-full max-w-xs\"\r\n                    >\r\n                        Выйти из аккаунта\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"w-full md:w-3/4\">\r\n                    <h2 className=\"text-2xl font-semibold mb-4\">Мои данные</h2>\r\n                    <div className=\"bg-white p-6 rounded-lg shadow-md border\">\r\n\r\n                        <div className=\"mb-4\">\r\n                            <label className=\"block text-sm font-medium text-gray-500\">Имя</label>\r\n                            <p className=\"text-lg\">{user.name}</p>\r\n                        </div>\r\n\r\n                        <div className=\"mb-4\">\r\n                            <label className=\"block text-sm font-medium text-gray-500\">Email (Логин)</label>\r\n                            <p className=\"text-lg\">{user.email}</p>\r\n                        </div>\r\n\r\n\r\n\r\n                        <button className=\"mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors\">\r\n                            Редактировать профиль\r\n                        </button>\r\n                    </div>\r\n\r\n                    <h2 className=\"text-2xl font-semibold mt-10 mb-4\">История Заказов</h2>\r\n\r\n                    <div className=\"p-6 bg-gray-50 rounded-lg shadow-inner\">\r\n                        <p className=\"text-gray-600\">Пока заказов нет. Самое время начать покупки!</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n        </div>\r\n    );\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/profile/page.tsx b/app/profile/page.tsx
--- a/app/profile/page.tsx	(revision 73ce9bec024038fa1fdaf282b016616e948edbf0)
+++ b/app/profile/page.tsx	(date 1765765771039)
@@ -1,14 +1,56 @@
+// app/profile/page.tsx
 "use client";
 
 import { useSession, signOut } from "next-auth/react";
 import { useRouter } from "next/navigation";
+import { useState, useEffect } from "react";
+
+// --- УТИЛИТА: ОТПРАВКА ФАЙЛА НА СЕРВЕР (/api/upload) ---
+const uploadFile = async (file: File): Promise<string> => {
+    const formData = new FormData();
+    // 'avatar' - это имя поля, которое ожидает сервер в app/api/upload/route.ts
+    formData.append('avatar', file);
+
+    const res = await fetch('/api/upload', {
+        method: 'POST',
+        body: formData,
+    });
+
+    if (!res.ok) {
+        // Получаем детальное сообщение об ошибке с сервера
+        const errorData = await res.json();
+        throw new Error(errorData.message || "Ошибка загрузки файла на сервер.");
+    }
+
+    const data = await res.json();
+    return data.imageUrl; // Возвращаем публичный путь к сохраненному файлу
+};
+// ----------------------------------------------------
+
 
 export default function ProfilePage() {
-    const { data: session, status } = useSession();
+    // Получаем функцию update из useSession для обновления данных на клиенте
+    const { data: session, status, update } = useSession();
     const router = useRouter();
 
+    // Инициализация состояний: используем оператор опциональной цепочки
+    const [name, setName] = useState(session?.user?.name || "");
+    const [avatarUrl, setAvatarUrl] = useState(session?.user?.image || "/images/avatar-default.png");
+    const [isSaving, setIsSaving] = useState(false);
+    const [message, setMessage] = useState<{ text: string, type: 'success' | 'error' } | null>(null);
+    const [file, setFile] = useState<File | null>(null);
+
+    // Синхронизация данных сессии при загрузке или обновлении сессии
+    useEffect(() => {
+        if (session) {
+            setName(session.user.name || "");
+            setAvatarUrl(session.user.image || "/images/avatar-default.png");
+        }
+    }, [session]);
+
+    // --- Защита маршрута и обработка статусов ---
     if (status === "loading") {
-        return <div className="p-8 text-center">Загрузка...</div>;
+        return <div className="p-8 text-center">Загрузка данных пользователя...</div>;
     }
 
     if (status === "unauthenticated") {
@@ -16,58 +58,158 @@
         return null;
     }
 
+    // --- ИСПРАВЛЕНИЕ TS18047: Утверждение ненулевого значения ---
+    // После проверок 'loading' и 'unauthenticated' мы уверены, что session и session.user существуют.
     const user = session!.user!;
+    // -----------------------------------------------------------
+
+    // --- ОБРАБОТЧИК ФОРМЫ ---
+    const handleSubmit = async (e: React.FormEvent) => {
+        e.preventDefault();
+        setIsSaving(true);
+        setMessage(null);
+
+        let newAvatarUrl = avatarUrl;
+
+        // 1. ЕСЛИ ВЫБРАН ФАЙЛ, СНАЧАЛА ЗАГРУЖАЕМ ЕГО
+        if (file) {
+            try {
+                newAvatarUrl = await uploadFile(file);
+            } catch (error) { // Корректная обработка ошибки типа unknown
+                const errorMessage = error instanceof Error ? error.message : "Неизвестная ошибка загрузки аватара.";
+                setMessage({ text: errorMessage, type: 'error' });
+                setIsSaving(false);
+                return; // Прекращаем выполнение, если загрузка файла не удалась
+            }
+        }
+
+        // 2. ОБНОВЛЯЕМ ПРОФИЛЬ (с новым URL или без него)
+        try {
+            const res = await fetch('/api/profile', {
+                method: 'PUT',
+                headers: { 'Content-Type': 'application/json' },
+                body: JSON.stringify({ name, image: newAvatarUrl }),
+            });
+
+            const data = await res.json();
+
+            if (res.ok) {
+                // 3. Обновляем сессию NextAuth.js
+                await update({
+                    name: data.user.name,
+                    image: data.user.image
+                });
+
+                setAvatarUrl(data.user.image);
+                setFile(null); // Сбрасываем выбранный файл
+                setMessage({ text: data.message, type: 'success' });
+            } else {
+                setMessage({ text: data.message || "Ошибка обновления", type: 'error' });
+            }
+        } catch (err) { // Корректная обработка ошибки типа unknown
+            const errorMessage = err instanceof Error ? err.message : "Произошла ошибка сети";
+            setMessage({ text: errorMessage, type: 'error' });
+        } finally {
+            setIsSaving(false);
+        }
+    };
+
+    // --- Обработчик выбора файла ---
+    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
+        const selectedFile = e.target.files?.[0];
+        if (selectedFile && selectedFile.type.startsWith('image/')) {
+            setFile(selectedFile);
+            const reader = new FileReader();
+            reader.onload = (e) => {
+                setAvatarUrl(e.target?.result as string);
+            };
+            reader.readAsDataURL(selectedFile);
+        } else {
+             setFile(null);
+             setMessage({ text: "Пожалуйста, выберите файл изображения.", type: 'error' });
+        }
+    };
+
 
     return (
         <div className="px-[max(12px,calc((100%-1208px)/2))] py-20 min-h-[60vh]">
-            <h1 className="text-3xl font-bold mb-8 border-b pb-4">Личный Кабинет</h1>
+            <h1 className="text-3xl font-bold mb-8 border-b pb-4">Редактирование Профиля</h1>
 
-            <div className="flex flex-col md:flex-row gap-12">
+            <form onSubmit={handleSubmit} className="flex flex-col md:flex-row gap-12">
+
+                {/* Левая колонка: Аватар и Выход */}
                 <div className="w-full md:w-1/4 flex flex-col items-center">
                     <img
-                        src="/images/avatar.jpg"
-                        alt={user.name || "Аватар"}
+                        src={avatarUrl}
+                        alt={name || "Аватар"}
                         width={120} height={120}
-                        className="rounded-full shadow-lg mb-4"
+                        className="rounded-full shadow-lg mb-4 object-cover border-4 border-white ring-2 ring-gray-300"
+                    />
+
+                    {/* Кнопка загрузки файла */}
+                    <label htmlFor="avatar-upload" className="cursor-pointer bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition-colors">
+                        {file ? `Выбран: ${file.name}` : "Выбрать аватар"}
+                    </label>
+                    <input
+                        id="avatar-upload"
+                        type="file"
+                        accept="image/*"
+                        onChange={handleFileChange}
+                        className="hidden"
                     />
-                    <p className="text-xl font-semibold mb-2">{user.name}</p>
 
+                    {/* Кнопка выхода */}
                     <button
-                        onClick={() => signOut({ callbackUrl: '/auth/login' })} // Перенаправляем на логин после выхода
-                        className="mt-4 bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600 transition-colors w-full max-w-xs"
+                        onClick={() => signOut({ callbackUrl: '/auth/login' })}
+                        className="mt-8 bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600 transition-colors w-full max-w-xs"
+                        type="button"
                     >
                         Выйти из аккаунта
                     </button>
                 </div>
 
+                {/* Правая колонка: Форма данных */}
                 <div className="w-full md:w-3/4">
-                    <h2 className="text-2xl font-semibold mb-4">Мои данные</h2>
+                    <h2 className="text-2xl font-semibold mb-4">Основные данные</h2>
+
                     <div className="bg-white p-6 rounded-lg shadow-md border">
 
+                        {/* Сообщение об ошибке/успехе */}
+                        {message && (
+                            <div className={`p-3 mb-4 rounded ${message.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
+                                {message.text}
+                            </div>
+                        )}
+
                         <div className="mb-4">
-                            <label className="block text-sm font-medium text-gray-500">Имя</label>
-                            <p className="text-lg">{user.name}</p>
+                            <label htmlFor="name" className="block text-sm font-medium text-gray-700">Имя</label>
+                            <input
+                                id="name"
+                                type="text"
+                                value={name}
+                                onChange={(e) => setName(e.target.value)}
+                                required
+                                className="mt-1 block w-full p-3 border border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500"
+                            />
                         </div>
 
                         <div className="mb-4">
-                            <label className="block text-sm font-medium text-gray-500">Email (Логин)</label>
-                            <p className="text-lg">{user.email}</p>
+                            <label className="block text-sm font-medium text-gray-700">Email (нельзя изменить)</label>
+                            <p className="text-lg p-3 bg-gray-50 border border-gray-300 rounded-md">
+                                {user.email}
+                            </p>
                         </div>
 
-
-
-                        <button className="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
-                            Редактировать профиль
+                        <button
+                            type="submit"
+                            disabled={isSaving}
+                            className="mt-4 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-400 font-semibold"
+                        >
+                            {isSaving ? 'Сохранение...' : 'Сохранить изменения'}
                         </button>
                     </div>
-
-                    <h2 className="text-2xl font-semibold mt-10 mb-4">История Заказов</h2>
-
-                    <div className="p-6 bg-gray-50 rounded-lg shadow-inner">
-                        <p className="text-gray-600">Пока заказов нет. Самое время начать покупки!</p>
-                    </div>
                 </div>
-            </div>
+            </form>
 
         </div>
     );
